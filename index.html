<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Olympic Medals Narrative</title>
  <style>
    body { 
      font-family: sans-serif;
      margin: 0;
      padding: 0; 
    }
    #vis-container {
      padding: 20px;
    }
    #controls {
      text-align: center;
      margin: 10px;
    }
    button, select {
      margin: 0 5px;
      padding: 5px 10px;
    }
    .tooltip {
      position: absolute;
      background: rgba(0,0,0,0.7);
      color: #fff; 
      padding: 5px 8px;
      border-radius: 4px;
      pointer-events: none;
      font-size: 12px;
    }
    .brush .selection {
      fill: #aaa;
      fill-opacity: 0.3;
    }
  </style>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-svg-annotation@2"></script>
</head>
<body>
  <div id="vis-container"></div>
  <div id="controls">
    <button id="prev">‚Üê Prev</button>
    <span id="scene-label">Scene¬†1</span>
    <button id="next">Next ‚Üí</button>
  </div>
<script>
  const annotation = d3.annotation;
  const state = { currentScene:1, yearRange:null, visibleCountries:new Set(), selectedCountry:null };

  Promise.all([
    d3.csv("scene1.csv", d3.autoType),
    d3.csv("scene2.csv", d3.autoType),
    d3.csv("scene3.csv", d3.autoType)
  ]).then(([sc1,sc2,sc3])=>{
    state.yearRange = d3.extent(sc1, d=>d.Year);
    sc2.map(d=>d.Country).forEach(c=>state.visibleCountries.add(c));
    state.selectedCountry = sc3[0].Country;

    d3.select("#next").on("click",()=>{
      if(state.currentScene<3) state.currentScene++;
      drawScene(sc1,sc2,sc3);
    });
    d3.select("#prev").on("click",()=>{
      if(state.currentScene>1) state.currentScene--;
      drawScene(sc1,sc2,sc3);
    });

    drawScene(sc1,sc2,sc3);
  });

function drawScene(sc1, sc2, sc3) {
    d3.select("#vis-container").html("");
    d3.select("#scene-label").text(`Scene¬†${state.currentScene}`);

    if(state.currentScene===1) drawScene1(sc1);
    else if(state.currentScene===2) drawScene2(sc2);
    else drawScene3(sc3);
  }

  function drawScene1(data) {
    const m = {t:40,r:20,b:80,l:60}, W=800-m.l-m.r, H=400-m.t-m.b;
    
    const svg = d3.select("#vis-container")
      .append("svg").attr("width",W+m.l+m.r).attr("height",H+m.t+m.b)
      .append("g").attr("transform",`translate(${m.l},${m.t})`);
    
    const x = d3.scaleLinear().domain(state.yearRange).range([0,W]);
    const y = d3.scaleLinear().domain(d3.extent(data,d=>d.TotalMedals)).range([H,0]);
    
    svg.append("path").datum(data)
      .attr("d", d3.line().x(d=>x(d.Year)).y(d=>y(d.TotalMedals)))
      .attr("fill","none").attr("stroke","#333").attr("stroke-width",2);
    
    svg.append("g").attr("transform",`translate(0,${H})`).call(d3.axisBottom(x).tickFormat(d3.format("d")));
    svg.append("g").call(d3.axisLeft(y));

    // tooltip
    const tip = d3.select("body").append("div").attr("class","tooltip").style("opacity",0);
    svg.selectAll("circle").data(data).join("circle")
      .attr("cx",d=>x(d.Year)).attr("cy",d=>y(d.TotalMedals)).attr("r",4)
      .on("mouseover",(e,d)=>{
        tip.style("opacity",1).html(`${d.Year}: ${d.TotalMedals}`)
           .style("left",e.pageX+10+"px").style("top",e.pageY-20+"px");
      })
      .on("mouseout",()=>tip.style("opacity",0));

    // brush
    const brush = d3.brushX().extent([[0,H+10],[W,H+40]]).on("end",e=>{
      if(!e.selection) return;
      state.yearRange = e.selection.map(x.invert);
      drawScene1(data);
    });
    svg.append("g").attr("class","brush").call(brush);

    // annotation
    const firstCount = data.find(d=>d.Year===1896).TotalMedals;
    const anno = annotation().annotations([{
      note:{title:"üèÖ First Games",label:"122 medals in 1896"},
      x:x(1896), y:y(data.find(d=>d.Year===1896).TotalMedals), dx:10, dy:-30
    }]);
    svg.append("g").call(anno);
  }
    function drawScene2(data) {
      const m = {t:40, r:20, b:60, l:60}, W = 800 - m.l - m.r, H = 400 - m.t - m.b;

      const svg = d3.select("#vis-container")
        .append("svg").attr("width", W+m.l+m.r).attr("height", H+m.t+m.b)
        .append("g").attr("transform", `translate(${m.l},${m.t})`);

      const filtered = data.filter(d=>state.visibleCountries.has(d.Country));
      const years = [...new Set(filtered.map(d=>d.Year))].sort((a,b)=>a-b);
      const countries = [...state.visibleCountries];

      const x = d3.scaleLinear().domain(d3.extent(years)).range([0,W]);
      const y = d3.scaleLinear().domain([0, d3.max(filtered, d=>d.MedalCount)]).range([H,0]);
      const color = d3.scaleOrdinal(d3.schemeCategory10).domain(countries);

      countries.forEach(c => {
        const series = filtered.filter(d=>d.Country===c);
        svg.append("path")
          .datum(series)
          .attr("d", d3.line().x(d=>x(d.Year)).y(d=>y(d.MedalCount)))
          .attr("stroke", color(c))
          .attr("fill","none")
          .attr("stroke-width",2)
          .attr("opacity",0.8);
      });

      svg.append("g").attr("transform",`translate(0,${H})`).call(d3.axisBottom(x).tickFormat(d3.format("d")));
      svg.append("g").call(d3.axisLeft(y));

      // legend toggles
      const legend = svg.append("g").attr("transform",`translate(${W-100},0)`);
      countries.forEach((c,i)=>{
        const g = legend.append("g").attr("transform",`translate(0,${i*20})`);
        g.append("rect")
          .attr("width",12).attr("height",12)
          .attr("fill", color(c))
          .on("click", ()=>{
            state.visibleCountries.has(c)
              ? state.visibleCountries.delete(c)
              : state.visibleCountries.add(c);
            drawScene2(data);
          });
        g.append("text")
          .attr("x",18).attr("y",10)
          .text(c);
      });
    }
  function drawScene3(data) {
      const m = {t:40, r:20, b:60, l:60}, W = 600 - m.l - m.r, H = 400 - m.t - m.b;

      const svg = d3.select("#vis-container")
        .append("svg").attr("width", W+m.l+m.r).attr("height", H+m.t+m.b)
        .append("g").attr("transform", `translate(${m.l},${m.t})`);

      const countries = [...new Set(data.map(d=>d.Country))];
      let dd = d3.select("#controls").selectAll("select").data([null]);
      dd.enter().append("select")
          .on("change", function() {
            state.selectedCountry = this.value;
            drawScene3(data);
          })
        .merge(dd)
          .selectAll("option").data(countries).join("option").attr("value", d=>d).attr("selected", d=>d===state.selectedCountry)
          .text(d=>d);

      const row = data.find(d=>d.Country===state.selectedCountry);
      const types = ["Gold","Silver","Bronze"],
            counts = types.map(t=>row[t]);

      const x = d3.scaleBand().domain(types).range([0,W]).padding(0.3);
      const y = d3.scaleLinear().domain([0,d3.max(counts)]).range([H,0]);

      svg.selectAll("rect").data(types).join("rect")
        .attr("x", d=>x(d))
        .attr("y", d=>y(row[d]))
        .attr("width", x.bandwidth())
        .attr("height", d=>H - y(row[d]));

      svg.append("g")
        .attr("transform", `translate(0,${H})`)
        .call(d3.axisBottom(x));
      svg.append("g").call(d3.axisLeft(y));

      // annotation
      const highest = types[counts.indexOf(d3.max(counts))];
      const anno = d3.annotation().annotations([{
        note:{ title:`${highest} Leader`, label:`Most ${highest.toLowerCase()}s` },
        x: x(highest)+x.bandwidth()/2,
        y: y(row[highest]),
        dx: 0, dy: -30
      }]);
      svg.append("g").call(anno);
    }
</script>
</body>
</html>
